# 用户中心原型交互设计

## 1. 设计目标

- **统一账号体系：** 支持多系统共享用户与权限数据，避免重复维护。
- **灵活权限控制：** 基于 RBAC (Role‑Based Access Control) + 细粒度资源权限，满足不同系统/租户差异化需求。
- **可视化操作：** 通过列表、树形、矩阵等交互组件，让非技术人员也能便捷管理用户、角色、菜单、权限。
- **易扩展：** 预留租户、组织架构、自定义字段等扩展点，支持后续新系统快速接入。

## 2. 信息架构 (Site Map)

```
用户中心
├── 仪表盘 Dashboard
│   ├── 用户管理
│   │   ├── 用户列表
│   │   └── 用户详情
│   ├── 角色管理
│   │   ├── 角色列表
│   │   ├── 角色详情
│   │   └── 角色权限授权
│   ├── 菜单管理
│   │   ├── 菜单树
│   │   └── 菜单归属系统/微前端
│   ├── 权限管理
│   │   ├── 权限资源列表
│   │   └── 权限分组 & 标签
│   └── 授权中心
│       ├── 角色 ↔ 权限矩阵
│       ├── 用户 ↔ 角色授权
│       └── 系统/租户范围设置
```

## 3. 关键实体与关系

| 实体               | 关键字段                                         | 描述             |
| ------------------ | ------------------------------------------------ | ---------------- |
| **User**           | id, username, email, phone, status, tenant_id    | 系统账号         |
| **Role**           | id, name, description, level, tenant_id          | 一组权限集合     |
| **Menu**           | id, parent_id, name, url, component, system_code | 前端路由节点     |
| **Permission**     | id, code, name, type(API/BTN), system_code       | 细粒度资源       |
| **UserRole**       | user_id, role_id                                 | N\:N 关系        |
| **RolePermission** | role_id, permission_id                           | N\:N 关系        |
| **RoleMenu**       | role_id, menu_id                                 | 控制前端可见菜单 |

> **多系统兼容策略：** 以上实体皆含 `system_code` / `tenant_id` 字段，用于区分所属系统或租户，实现隔离与复用。

## 4. 页面原型说明

### 4.1 用户列表

- **筛选项：** 关键字、状态、所属系统、租户、创建时间。
- **操作：** 新增、编辑、重置密码、停启用。
- **交互细节：** 点击行展开侧边抽屉显示用户详情。

### 4.2 角色详情页

- **信息区域：** 基本信息卡片 + 角色成员计数。
- **权限配置：** Tab 1 菜单树勾选；Tab 2 权限资源多选列表；Tab 3 成员列表。
- **保存策略：** 跨 Tab 修改统一缓存在前端，点击 "保存" 一次性提交。

### 4.3 菜单树编辑器

- 树形 + 拖拽排序；节点支持增删改；支持一键同步前端路由文件。
- 节点属性：名称、图标、路径、组件路径、隐藏/缓存开关。

### 4.4 权限矩阵

- 左列列出 **角色**，上方列出 **权限分组** (列可横向滚动)。
- 单元格为勾选框。

### 4.5 授权流程 Wizard

1. 选择 "目标系统 → 目标角色/权限模板"。
2. 选择 "用户/部门/租户" 目标范围。
3. 确认摘要 & 提交。
4. 结果页提供操作日志 & 撤回入口。

## 5. 全量交互流程

> 以下拆解覆盖 **创建 / 查看 / 编辑 / 删除 / 授权 / 审计** 全链路操作，包含按钮权限点及预期结果，方便产品、研发、测试三方对齐。

### 5.1 用户管理

| 编号 | 场景            | 操作路径                                          | 关键权限      | 结果                                          |
| ---- | --------------- | ------------------------------------------------- | ------------- | --------------------------------------------- |
| U‑1  | **创建用户**    | 用户列表 → 新增 → 填写表单 → 保存                 | `user:create` | 新用户记录 & 默认角色写入；日志 "create-user" |
| U‑2  | **查看详情**    | 用户列表 → 点击行/"查看"                          | `user:list`   | 抽屉/详情页展示基本信息、角色、登录日志       |
| U‑3  | **编辑用户**    | 用户详情 → 编辑 → 修改 → 保存                     | `user:update` | 信息更新；版本校验；日志 "update-user"        |
| U‑4  | **重置密码**    | 用户详情 → 重置密码 → 确认                        | `user:update` | 新密码短信/邮件；记录安全日志                 |
| U‑5  | **停用 / 启用** | 用户列表 → 更多 → 停用/启用                       | `user:update` | `status` 字段变更，立即生效                   |

### 5.2 角色管理

| 编号 | 场景             | 操作路径                      | 关键权限               | 结果                           |
| ---- | ---------------- | ----------------------------- | ---------------------- | ------------------------------ |
| R‑1  | **创建角色**     | 角色列表 → 新增 → 填写 → 保存 | `role:create`          | 新角色生成                     |
| R‑2  | **查看详情**     | 角色列表 → 查看               | `role:list`            | 角色信息 + 成员数              |
| R‑3  | **编辑角色信息** | 角色详情 → 编辑 → 保存        | `role:update`          | 名称 / 等级 / 描述更新         |
| R‑4  | **角色授权**     | 角色详情 → 权限树勾选 → 保存  | `role:update` + 各资源 | 角色‑资源映射更新；热刷新权限  |
| R‑5  | **删除角色**     | 角色列表 → 删除               | `role:delete`          | 软删；若绑定用户则提示需先解绑 |

### 5.3 资源管理（目录 / 菜单 / 按钮）

| 编号 | 场景                   | 操作路径                               | 关键权限          | 结果                     |
| ---- | ---------------------- | -------------------------------------- | ----------------- | ------------------------ |
| RS‑1 | **新增目录/菜单/按钮** | 资源树 → 选父节点 → 新增 → 填写 → 保存 | `resource:create` | 节点加入树；实时预览     |
| RS‑2 | **查看资源详情**       | 资源树 → 点击节点                      | `resource:list`   | 只读面板展示字段         |
| RS‑3 | **编辑资源**           | 资源详情 → 编辑 → 保存                 | `resource:update` | 字段变更；URL/组件热更新 |
| RS‑4 | **删除资源**           | 资源树 → 删除                          | `resource:delete` | 软删；若有子节点阻止删除 |

### 5.5 系统与审计

| 编号 | 场景             | 操作路径                                  | 关键权限               | 结果                     |
| ---- | ---------------- | ----------------------------------------- | ---------------------- | ------------------------ |
| S‑1  | **多系统切换**   | 顶部系统选择器 → 选择系统                 | `system:switch` (隐式) | 刷新菜单/资源树/权限缓存 |

---

## 6. API 设计（RESTful）

> 所有接口返回统一 Response Envelope：
>
> ```jsonc
> {
>   "code": 0,          // 0=成功，其他=错误码
>   "message": "OK",   // 错误信息
>   "data": { ... }     // 业务数据
> }
> ```
>
> - **分页**：查询类接口使用 `?cursor=` + `?limit=`；返回 `nextCursor`。
> - **鉴权**：除登录外全部走 Bearer Token；按钮权限与 API `perm_code` 一一对应。

### 6.1 身份与会话

| Method | Path                | 权限 | 描述                                           |
| ------ | ------------------- | ---- | ---------------------------------------------- |
| POST   | `/api/auth/login`   | -    | 用户名 / 密码登录，返回 token + `perm_codes[]` |
| POST   | `/api/auth/refresh` | -    | 刷新 Token                                     |
| POST   | `/api/auth/logout`  | -    | 注销当前会话                                   |

### 6.2 用户模块

| Method | Path                             | 权限          | 描述                                                      |
| ------ | -------------------------------- | ------------- | --------------------------------------------------------- |
| GET    | `/api/users`                     | `user:list`   | 分页查询；支持 keyword / status / tenant_id / system_code |
| POST   | `/api/users`                     | `user:create` | 新增用户                                                  |
| GET    | `/api/users/{id}`                | `user:list`   | 获取用户详情                                              |
| PUT    | `/api/users/{id}`                | `user:update` | 修改用户信息                                              |
| PATCH  | `/api/users/{id}/status`         | `user:update` | 启 / 停用用户                                             |
| POST   | `/api/users/{id}/reset-password` | `user:update` | 重置密码，返回临时密码                                    |
| DELETE | `/api/users/{id}`                | `user:delete` | 软删除用户                                                |

### 6.3 角色模块

| Method | Path                    | 权限          | 描述                                         |
| ------ | ----------------------- | ------------- | -------------------------------------------- |
| GET    | `/api/roles`            | `role:list`   | 角色分页查询                                 |
| POST   | `/api/roles`            | `role:create` | 创建角色                                     |
| GET    | `/api/roles/{id}`       | `role:list`   | 角色详情                                     |
| PUT    | `/api/roles/{id}`       | `role:update` | 修改角色基本信息                             |
| DELETE | `/api/roles/{id}`       | `role:delete` | 删除角色（软删）                             |
| GET    | `/api/roles/{id}/perms` | `role:list`   | 查询角色已授权资源 ID 列表                   |
| PUT    | `/api/roles/{id}/perms` | `role:update` | 保存角色资源授权；body: `{ resourceIds:[] }` |

### 6.4 资源模块（目录 / 菜单 / 按钮）

| Method | Path                          | 权限              | 描述                                   |
| ------ | ----------------------------- | ----------------- | -------------------------------------- |
| GET    | `/api/resources/tree`         | `resource:list`   | 按 system_code 返回完整树              |
| POST   | `/api/resources`              | `resource:create` | 新增目录 / 菜单 / 按钮（type 随 body） |
| GET    | `/api/resources/{id}`         | `resource:list`   | 资源详情                               |
| PUT    | `/api/resources/{id}`         | `resource:update` | 修改资源                               |
| DELETE | `/api/resources/{id}`         | `resource:delete` | 删除资源（含子节点校验）               |
| GET    | `/api/resources/check-unique` | `resource:list`   | 唯一性校验（url / perm_code）          |

### 6.5 授权中心 & 范围

| Method | Path                           | 权限           | 描述                                 |
| ------ | ------------------------------ | -------------- | ------------------------------------ |
| GET    | `/api/grants/role-perm/matrix` | `role:list`    | 角色 × 资源矩阵数据（分页/分片加载） |
| GET    | `/api/grants/user-role/table`  | `user:list`    | 用户 × 角色表数据                    |
| GET    | `/api/scopes`                  | `scope:list`   | 获取系统 / 租户范围规则              |
| PUT    | `/api/scopes`                  | `scope:update` | 保存范围规则                         |

### 6.6 系统与审计

| Method | Path               | 权限           | 描述                                           |
| ------ | ------------------ | -------------- | ---------------------------------------------- |
| GET    | `/api/systems`     | `system:list`  | 当前账号可见系统列表（顶栏切换）               |
| GET    | `/api/logs`        | `audit:list`   | 分页查询操作日志；支持过滤 type / actor / date |
| GET    | `/api/logs/export` | `audit:export` | 导出日志 XLSX                                  |

> **命名规范**：统一小写复数资源名；删除均为软删。

---

. 安全与审计

- **单点登录 (SSO)：** 与公司统一认证中心对接，支持 OAuth2 / OIDC。
- **多因素认证 (MFA)：** 邮件 + 手机短信 + TOTP，可在用户详情开启。
- **操作日志：** 记录关键增删改授权行为，支持导出 & Webhook 告警。
- **数据脱敏：** 仅超级管理员可查看完整手机号/邮箱。

## 8. 未来扩展

- **组织架构树 (部门/岗位)**：可与用户、角色关联，实现更灵活的授权维度。
- **自定义字段引擎**：支持业务方按需扩展用户表字段。
- **细粒度数据权限**：行级、字段级过滤规则。
- **SaaS 多租户**：Logic + DB 隔离策略。

---

💡 _如需对页面交互、数据模型或流程做进一步调整，欢迎在聊天中指出，我会实时迭代文档。_

## 9. 菜单字段 → UI 标签

| 字段           | 列/表单标签 | 说明                                              |
| -------------- | ----------- | ------------------------------------------------- |
| name           | 菜单名称    | 左侧菜单树 & 列表主要显示文字                     |
| url            | 路由地址    | 以 `/` 开头，唯一标识路由                         |
| component      | 组件路径    | 相对 `views` 路径，自动 `import.meta.glob` 匹配   |
| icon           | 图标        | 如 `User`、`Home`；配合图标选择器组件             |
| keepAlive      | 缓存        | 开/关 `Switch`；悬停提示"是否加入 `<keep-alive>`" |
| system_code    | 所属系统    | 下拉框，多系统场景必填                            |
| parent_id      | 上级菜单    | `TreeSelect`；根节点可为空                        |
| id             | 菜单 ID     | 隐藏字段（后台自增）                              |
| code / name_en | 菜单编码    | 仅在"高级设置"Tab 显示，用于国际化 & 权限码       |

### UI 展示建议

- **菜单列表页**
  - 列：菜单名称 | 路由地址 | 组件路径 | 图标 | 缓存 (✔/✘) | 所属系统 | 操作

- **编辑弹窗 / 抽屉表单**
  1. **基本信息区**：菜单名称、上级菜单、图标、所属系统
  2. **路由配置区**：路由地址、组件路径、缓存开关
  3. **高级设置区**（折叠）：菜单编码、排序号、外链/隐藏开关

> 表单标签统一使用中文 4~6 字短语；通过 `HelpTooltip` 在标签旁提供英文字段与示例值，降低认知负担。

---

## 10. 按钮权限（Action 权限）控制

### 10.1 数据模型

| 实体           | 关键字段                                           | 说明                          |
| -------------- | -------------------------------------------------- | ----------------------------- |
| **Permission** | id, code, name, type = "BTN", menu_id, system_code | 绑定至具体页面菜单的按钮/操作 |

> `menu_id` 外键确保按钮权限永远归属某个页面，方便分组展示。

### 10.2 配置入口

1. **菜单树编辑器 → 按钮列表子面板**
   - 打开某菜单节点时，在右侧显示"页面元素(按钮)"表格。
   - 支持新增/编辑/删除按钮权限；字段：按钮名称、权限 Code、排序号、说明。

2. **权限资源列表** 仍可统一浏览/搜索 type = BTN 的全部按钮权限。

### 10.3 授权方式

- **角色详情页 Tab2 – 权限资源**：按 `菜单 → 按钮` 二级分组渲染复选框。
- **权限矩阵**：在行列交叉区域加入按钮权限（可按菜单折叠展示）。

### 10.4 前端实现

```ts
// 登录后获取当前用户拥有的权限 Code
const { data: codes } = await api.getMyPermissions()
store.setPermissionCodes(codes) // Pinia/Vuex

// 指令：隐藏无权限按钮
app.directive('permission', {
  mounted(el, binding) {
    if (!store.permissionCodes.includes(binding.value)) {
      el.parentNode?.removeChild(el) // 或者 el.disabled = true
    }
  }
})

// 使用
<Button v-permission="'user:add'">新增用户</Button>
```

- **隐藏 vs. 禁用**：默认隐藏；若需保留按钮灰化可改为 `el.disabled = true` 并添加样式。

### 10.5 后端拦截

- 推荐按钮 Code 与 API Code 对齐（或保持可推导规则），后端可统一通过 `@PreAuthorize("hasAuthority('user:add')")` 校验，防止前端绕过。

### 10.6 UI 交互要点

| 环节         | 交互细节                                                                                      |
| ------------ | --------------------------------------------------------------------------------------------- |
| 菜单树编辑器 | 点击菜单节点 → 展开"按钮列表"Tab；新增时自动生成 code 建议：`${menu.code}:${camelCase(name)}` |
| 角色赋权     | 角色详情页权限树中，勾选菜单节点的同时，子节点显示所有按钮权限。              |
| 权限审计     | 操作日志记录"按钮权限变更"事件：角色 id、按钮 code、操作人、时间。                            |

---

💡 _按钮权限的粒度越细，管理复杂度越高。通常只为「新增 / 编辑 / 删除 / 导出 / 审批」等敏感操作配置按钮权限，避免过度碎片化。_

---

## 11. 页面字段清单

> 本节列出主要页面（列表 / 详情 / 编辑）的字段及展示方式，方便 UI/后端接口对齐。列顺序即前端默认排序，可按需求配置隐藏/显示。

### 11.1 用户模块

#### 11.1.1 用户列表

| 列顺序 | 字段       | 说明        | UI 组件                               |
| ------ | ---------- | ----------- | ------------------------------------- |
| 1      | username   | 用户名      | 链接（跳详情）                        |
| 2      | nickname   | 昵称        | 文本                                  |
| 3      | email      | 邮箱        | `mailto:` 链接                        |
| 4      | phone      | 手机号      | 文本（脱敏：前三后四）                |
| 5      | tenantName | 所属租户    | Tag                                   |
| 6      | rolesCount | 角色数      | Badge                                 |
| 7      | status     | 状态(启/停) | Switch + 颜色点                       |
| 8      | createdAt  | 创建时间    | 日期                                  |
| 9      | actions    | 操作        | 按钮组：查看 / 编辑 / 重置密码 / 更多 |

#### 11.1.2 用户详情 & 编辑表单

| 区块     | 字段               | 说明         | 组件               |
| -------- | ------------------ | ------------ | ------------------ |
| 基本信息 | avatar             | 头像         | UploadAvatar       |
|          | username           | 用户名(只读) | InputReadOnly      |
|          | nickname           | 昵称         | Input              |
|          | email              | 邮箱         | Input + email 校验 |
|          | phone              | 手机         | Input + pattern    |
|          | status             | 启/停用      | RadioGroup         |
| 安全     | mfaEnabled         | MFA 状态     | Switch             |
|          | lastLoginAt        | 最近登录     | Text (只读)        |
| 组织     | tenantId           | 租户         | Select             |
|          | deptId             | 部门         | TreeSelect         |
| 角色     | roleIds            | 角色         | Transfer           |
| 扩展     | customFields\[...] | 自定义字段   | 动态渲染           |

### 11.2 角色模块

#### 11.2.1 角色列表

| 列  | 字段        | 说明               |            |
| --- | ----------- | ------------------ | ---------- |
| 1   | name        | 角色名 (链接)      |            |
| 2   | level       | 等级               | 数值/星标  |
| 3   | members     | 成员数             | 数字 Badge |
| 4   | system_code | 系统               | Tag        |
| 5   | description | 描述               | 文本截断…  |
| 6   | createdAt   | 创建时间           | 日期       |
| 7   | actions     | 查看 / 编辑 / 删除 |            |

#### 11.2.2 角色详情 & 编辑

| 分区   | 字段        | 说明           |
| ------ | ----------- | -------------- |
| 基本   | name        | 角色名         |
|        | level       | 等级 (1‑9)     |
|        | description | 描述           |
| 元数据 | createdAt   | 创建时间(只读) |
|        | updatedAt   | 更新日期(只读) |

### 11.3 资源模块（目录/菜单/按钮）

#### 11.3.1 资源树列表列（右侧表格）

| 列        | 字段      | 适用 type | 说明               |
| --------- | --------- | --------- | ------------------ |
| name      | name      | M/V/A     | 名称               |
| url       | url       | V/A       | 菜单路由 / 接口    |
| component | component | V         | 前端组件路径       |
| perm_code | perm_code | A         | 按钮权限码         |
| type      | type      | All       | M / V / A Badge    |
| icon      | icon      | V         | 图标               |
| sort      | sort      | All       | 排序号             |
| actions   | actions   | All       | 查看 / 编辑 / 删除 |

#### 11.3.2 资源详情 / 编辑字段

\| type=M | 字段：name, sort |
\| type=V | 字段：name, url, component, icon, keepAlive, sort |
\| type=A | 字段：name, perm_code, url, sort |

#### 11.3.3 `type` 字段作用

| 值    | 全称               | 图标/UI   | 业务含义                                                       | 约束规则                                           |
| ----- | ------------------ | --------- | -------------------------------------------------------------- | -------------------------------------------------- |
| **M** | Module / Directory | 📁 folder | 逻辑分组节点，仅做层级与折叠；不可绑定路由、不可授权           | 只能作为父节点；禁止删除若含子节点                 |
| **V** | View / Menu        | 📄 page   | 页面路由入口；对应前端组件；决定"查看权限"需其下 `*:list` 按钮 | 必须填写 `url` & `component`；可挂子按钮(A)        |
| **A** | Action / Button    | 🔘 button | 具体操作权限点；通过 `perm_code` 与接口/按钮绑定               | 叶子节点；必须唯一 `perm_code`；删除需同步角色授权 |

> **渲染逻辑**：前端 Tree 根据 `type` 渲染不同图标与可操作项；保存表单时根据 `type` 动态校验必填字段。| 字段：name, perm_code, url, sort |

### 11.4 授权中心

#### 11.4.1 角色 × 权限矩阵

| 行字段   | 列字段               | 单元格   | 备注                       |
| -------- | -------------------- | -------- | -------------------------- |
| roleName | resource (perm_code) | Checkbox | 资源按菜单折叠，按钮为叶子 |

#### 11.4.2 用户 × 角色表

| 列       | 字段              | 说明               |
| -------- | ----------------- | ------------------ |
| userInfo | username + avatar | 定位用户           |
| roles    | roleNames\[]      | 多 Tag，可内联编辑 |

> 若需为其他页面（如 Dashboard 统计卡、日志详情）补字段，请继续提出。
